@model ArtiaVet.Models.CitasProximasViewModel
@{
    ViewData["Title"] = "Citas";
}

<div class="flex min-h-screen bg-slate-700">
    @* Sidebar - Menú Lateral *@
    <partial name="_Sidebar"></partial>

    @* Contenedor principal con borde y fondo blanco *@
    <div class="flex-1 m-6 bg-white rounded-3xl overflow-hidden">
        @* Contenido interior con padding *@
        <div class="p-8 h-full w-full">

            @* Mensajes de éxito/error *@
            @if (TempData["Mensaje"] != null)
            {
                <div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                    @TempData["Mensaje"]
                </div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    @TempData["Error"]
                </div>
            }

            @* Header *@
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Citas</h1>
                    <p class="text-gray-400 text-sm">Próximos 7 días</p>
                </div>
                <button onclick="abrirModalCita()"
                    class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    <span class="text-gray-600">Nueva cita</span>
                    <div class="w-6 h-6 rounded-full border-2 border-gray-400 flex items-center justify-center">
                        <span class="text-gray-600 text-lg leading-none pb-0.5">+</span>
                    </div>
                </button>
            </div>

            @* Lista de citas por día *@
            <div class="space-y-8">
                @foreach (var dia in Model.CitasPorDias)
                {
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">
                                @if (dia.EsHoy)
                                {
                                    <span>Hoy</span>
                                }
                                else
                                {
                                    <span>@dia.DiaSemana, @dia.FechaFormateada</span>
                                }
                            </h2>
                        </div>

                        @if (dia.Citas.Any())
                        {
                            <div class="space-y-4">
                                @foreach (var cita in dia.Citas)
                                {
                                    <div onclick="abrirModalDetalleCita(@cita.Id)"
                                        class="flex items-center justify-between py-3 px-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center"
                                                style="background-color: blue">
                                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none"
                                                    xmlns="http://www.w3.org/2000/svg" stroke="#ffffff">
                                                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round">
                                                    </g>
                                                    <g id="SVGRepo_iconCarrier">
                                                        <path
                                                            d="M19.0803 15.7203C18.4903 12.1903 15.1003 9.32031 11.5203 9.32031C7.63028 9.32031 4.21028 12.4703 3.88028 16.3503C3.75028 17.8503 4.23028 19.2703 5.22028 20.3403C6.20028 21.4103 7.58028 22.0003 9.08028 22.0003H13.7603C15.4503 22.0003 16.9303 21.3403 17.9403 20.1503C18.9503 18.9603 19.3503 17.3803 19.0803 15.7203Z"
                                                            fill="#f9fffe"></path>
                                                        <path
                                                            d="M10.2796 7.86C11.8978 7.86 13.2096 6.54819 13.2096 4.93C13.2096 3.31181 11.8978 2 10.2796 2C8.66141 2 7.34961 3.31181 7.34961 4.93C7.34961 6.54819 8.66141 7.86 10.2796 7.86Z"
                                                            fill="#f9fffe"></path>
                                                        <path
                                                            d="M16.94 9.02844C18.2876 9.02844 19.38 7.93601 19.38 6.58844C19.38 5.24086 18.2876 4.14844 16.94 4.14844C15.5924 4.14844 14.5 5.24086 14.5 6.58844C14.5 7.93601 15.5924 9.02844 16.94 9.02844Z"
                                                            fill="#f9fffe"></path>
                                                        <path
                                                            d="M20.5496 12.9313C21.6266 12.9313 22.4996 12.0582 22.4996 10.9812C22.4996 9.90429 21.6266 9.03125 20.5496 9.03125C19.4727 9.03125 18.5996 9.90429 18.5996 10.9812C18.5996 12.0582 19.4727 12.9313 20.5496 12.9313Z"
                                                            fill="#f9fffe"></path>
                                                        <path
                                                            d="M3.94 10.9816C5.28757 10.9816 6.38 9.88914 6.38 8.54156C6.38 7.19399 5.28757 6.10156 3.94 6.10156C2.59243 6.10156 1.5 7.19399 1.5 8.54156C1.5 9.88914 2.59243 10.9816 3.94 10.9816Z"
                                                            fill="#f9fffe"></path>
                                                    </g>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-gray-800">@cita.NombreDueno</h3>
                                                <p class="text-sm text-gray-400">@cita.TipoCita • Dr. @cita.NombreVeterinario</p>
                                            </div>
                                        </div>
                                        <span class="text-gray-600 font-medium">@cita.HoraInicio</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-8 text-gray-400">
                                No hay citas programadas para este día
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@* Modales *@
<partial name="_ModalNuevaCita"></partial>
<partial name="_ModalNuevaMascota"></partial>
<partial name="_ModalNuevoDueno"></partial>
<partial name="_ModalDetalleCita"></partial>

<script>

    // Debug global
    window.__DEBUG_LOAD_DUENOS = true;

    // Logs centralizados
    function log(...args) { console.log('[INFO]', ...args); }
    function warn(...args) { console.warn('[WARN]', ...args); }
    function err(...args) { console.error('[ERROR]', ...args); }

    // --- Abrir modal ---
    async function abrirModalMascota() {
        log("abrirModalMascota()");
        document.getElementById('modalNuevaMascota').classList.remove('hidden');
        await cargarDuenosDropdown();
    }

    // --- Cerrar modal ---
    function cerrarModalMascota() {
        log("cerrarModalMascota()");
        document.getElementById('modalNuevaMascota').classList.add('hidden');
        document.getElementById('formNuevaMascota').reset();
    }

    // --- Cargar dueños ---
    async function cargarDuenosDropdown() {
        log("Iniciando carga de dueños...");

        const selects = Array.from(document.querySelectorAll('#DuenoID'));
        log("Selects #DuenoID encontrados:", selects.length);

        if (selects.length === 0) {
            warn("NO hay selects DuenoID en el DOM aún");
            return;
        }

        selects.forEach(s => s.innerHTML = '<option>Cargando...</option>');

        try {
            const res = await fetch('/Recepcionista/ObtenerDuenos');

            log("Status:", res.status);
            log("Content-Type:", res.headers.get('content-type'));

            const json = await res.json();
            const duenios = json.dueños || [];

            log("Dueños recibidos:", duenios.length);

            selects.forEach(sel => {
                sel.innerHTML = '<option value="">Seleccione un dueño</option>';
                duenios.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.value;
                    opt.textContent = d.text;
                    sel.appendChild(opt);
                });
            });

        } catch (e) {
            err("Error al cargar dueños", e);
        }
    }

    async function guardarMascota() {
        try {
            const form = document.getElementById('formNuevaMascota');
            if (!form) {
                console.error('guardarMascota: formNuevaMascota no encontrado');
                return;
            }

            // Validación HTML5
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Leer campos
            const nombre = document.getElementById('NombreMascota')?.value?.trim() ?? '';
            const tipoAnimalID = document.getElementById('TipoAnimalID')?.value ?? '';
            const duenoID = document.getElementById('DuenoID')?.value ?? '';
            const raza = document.getElementById('RazaMascota')?.value?.trim() ?? '';
            const edad = document.getElementById('EdadMascota')?.value ?? '';
            const notas = document.getElementById('NotasMascota')?.value?.trim() ?? '';

            // Validación mínima
            if (!nombre || !tipoAnimalID || !duenoID || !raza || !edad) {
                if (typeof mostrarErrorMascota === 'function') {
                    mostrarErrorMascota('Por favor complete todos los campos requeridos');
                } else {
                    alert('Por favor complete todos los campos requeridos');
                }
                return;
            }

            // Alergias (si existen checkboxes con name="AlergiasIDs")
            const alergiasCheckboxes = Array.from(document.querySelectorAll('input[name="AlergiasIDs"]:checked'));
            const alergiasIDs = alergiasCheckboxes.map(cb => parseInt(cb.value)).filter(v => !isNaN(v));

            const data = {
                Nombre: nombre,
                TipoAnimalID: parseInt(tipoAnimalID),
                DueñoID: parseInt(duenoID),
                Raza: raza,
                Edad: parseInt(edad),
                Notas: notas || null,
                AlergiasIDs: alergiasIDs
            };

            // Obtener token antiforgery
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : null;

            // Mostrar estado (opcional)
            const btnGuardar = Array.from(document.querySelectorAll('button'))
                .find(b => b.onclick && b.onclick.toString().includes('guardarMascota')) || null;
            if (btnGuardar) { btnGuardar.disabled = true; }

            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['X-CSRF-TOKEN'] = token;

            const res = await fetch('/Recepcionista/CrearMascota', {
                method: 'POST',
                headers,
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            // intentar parsear JSON (si devuelve HTML, se lanzará)
            const text = await res.text();
            let result;
            try { result = JSON.parse(text); }
            catch (parseErr) {
                console.error('guardarMascota: respuesta no JSON:', text.slice(0, 300));
                if (typeof mostrarErrorMascota === 'function') mostrarErrorMascota('Respuesta inválida del servidor');
                else alert('Respuesta inválida del servidor');
                return;
            }

            if (result.success) {
                // Actualizar selects de mascotas (puede haber varios: #MascotaID o .mascota-select)
                const selectsById = Array.from(document.querySelectorAll('#MascotaID'));
                const selectsByClass = Array.from(document.querySelectorAll('.mascota-select'));
                const selects = Array.from(new Set([...selectsById, ...selectsByClass]));

                // Si el backend devolvió result.mascotas (lista de { value, text })
                const mascotas = result.mascotas ?? result.data ?? [];

                if (Array.isArray(mascotas) && mascotas.length > 0) {
                    selects.forEach(s => {
                        try {
                            s.innerHTML = '<option value="">Seleccione una mascota</option>';
                            mascotas.forEach(m => {
                                const opt = document.createElement('option');
                                opt.value = m.value ?? m.Value ?? m.id ?? m.Id ?? '';
                                opt.textContent = m.text ?? m.Text ?? (m.nombre ?? '');
                                s.appendChild(opt);
                            });
                            // seleccionar la mascota creada si el server devolvió mascotaId
                            if (result.mascotaId) {
                                s.value = String(result.mascotaId);
                            }
                        } catch (err) {
                            console.warn('guardarMascota: no se pudo poblar select mascota', err);
                        }
                    });
                }

                // Mensaje de éxito y cierre de modal
                if (typeof mostrarExitoMascota === 'function') {
                    mostrarExitoMascota(result.mensaje || 'Mascota creada exitosamente');
                }

                // Cerrar modal y resetear
                setTimeout(() => {
                    try { cerrarModalMascota(); } catch (e) { }
                }, 300);

            } else {
                // Mostrar mensaje de error proveniente del servidor
                const msg = result.mensaje || 'Error al crear la mascota';
                if (typeof mostrarErrorMascota === 'function') mostrarErrorMascota(msg);
            }

        } catch (error) {
            console.error('guardarMascota: error inesperado', error);
            if (typeof mostrarErrorMascota === 'function') mostrarErrorMascota('Error al crear la mascota. Revisa la consola.');
        } finally {
            // re-habilitar botón
            const btnGuardar = Array.from(document.querySelectorAll('button'))
                .find(b => b.onclick && b.onclick.toString().includes('guardarMascota')) || null;
            if (btnGuardar) { btnGuardar.disabled = false; }
        }
    }

    function abrirModalDetalleCita(citaId) {
        fetch(`/Recepcionista/ObtenerDetalleCitaCompleto?id=${citaId}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const cita = result.data;

                    document.getElementById('detalleCitaId').textContent = cita.id;
                    document.getElementById('detalleVeterinario').textContent = cita.nombreVeterinario || 'N/A';
                    document.getElementById('detalleMascota').textContent = cita.nombreMascota || 'N/A';
                    document.getElementById('detalleDueno').textContent = cita.nombreDueno || 'N/A';
                    document.getElementById('detalleTipoCita').textContent = cita.tipoCita || 'N/A';

                    const fecha = new Date(cita.fechaCita);
                    document.getElementById('detalleFecha').textContent = fecha.toLocaleDateString('es-MX', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    document.getElementById('detalleHora').textContent = cita.horaInicio || 'N/A';
                    document.getElementById('detalleImporteTotal').textContent = `$${cita.importeTotal.toFixed(2)}`;
                    document.getElementById('detalleImporteAdicional').textContent = `$${cita.importeAdicional.toFixed(2)}`;
                    document.getElementById('detalleObservaciones').textContent = cita.observaciones || 'Sin observaciones';

                    const colorIndicator = document.getElementById('detalleColorIndicator');
                    if (colorIndicator && cita.colorFondo) {
                        colorIndicator.style.backgroundColor = cita.colorFondo;
                    }

                    document.getElementById('modalDetalleCita').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                } else {
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function cerrarModalDetalleCita() {
        document.getElementById('modalDetalleCita').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            cerrarModalDetalleCita();
        }
    });

</script>

</html>